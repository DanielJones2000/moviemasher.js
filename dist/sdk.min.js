"use strict";var Action,Audio,Colors,Constant,Defaults,Filter,Loader,Mash,Option,Player,Players,TimeRange,Util,MovieMasher=function e(){this.instance_arguments=arguments,this.MovieMasher=e,this.initialize()};MovieMasher.prototype.initialize=function(){},MovieMasher.configure=function(e){return Util.isob(e)&&Option.set(e),Option},MovieMasher.find=function(e,t,i){var r;return(t=Util.isob(t)?t[i||"id"]:t)&&(Util.isnt(MovieMasher.registered[e])&&(MovieMasher.registered[e]=[]),(r=Util.array_find(MovieMasher.registered[e],t,i))||((r=Defaults.module_for_type(e,t))?(MovieMasher.registered[e].push(r),MovieMasher.registered[e].sort(Util.sort_by_label)):console.error("could not find registered "+e,t))),r},MovieMasher.player=function(e){var t=null;return Util.isnt(e)&&(e={}),Util.isob(e)?(t=new Player(e),Players.instances.push(t)):t=Players.instances[e],t},MovieMasher.register=function(e,t){if(Util.isarray(t)||(t=[t]),Util.isob.apply(Util,t)){var i,r,a,s,n,o,_=t.length;if(_)for((a=Util.isnt(MovieMasher.registered[e]))&&(MovieMasher.registered[e]=[]),o=0;o<_;o++)n=t[o],r=Util.array_find(MovieMasher.registered[e],n),"com.moviemasher."+e+".default"===n.id&&(s=!0,r&&(Util.array_delete(MovieMasher.registered[e],r),r=null)),r||(n.type||(n.type=e),MovieMasher.registered[e].push(n),i=!0);a&&!s&&(n=Defaults.module_for_type(e))&&(MovieMasher.registered[e].push(n),i=!0,MovieMasher.registered[e].sort(Util.sort_by_label)),i&&MovieMasher.registered[e].sort(Util.sort_by_label)}},MovieMasher.registered={},MovieMasher.supported=!(!Object.defineProperty||!document.createElement("canvas").getContext||!window.AudioContext&&!window.webkitAudioContext),MovieMasher.Filter.register("blend",{render:function(e,t,i){if(e.length<2)return console.error("blend.apply with insufficient contexts",e);var r=e[0],a=e[1];if(!r)return console.error("blend.apply with no bot_ctx",e);if(!a)return console.error("blend.apply with no top_ctx",e);i=MovieMasher.Util.array_key(MovieMasher.Constant.property_types.mode.values,i.all_mode,"composite");return r.context.globalCompositeOperation=i,r.context.drawImage(a.canvas,0,0),r.context.globalCompositeOperation="normal",[r]}}),MovieMasher.Filter.register("chromakey",{render:function(e,t,i){for(var r,a,s,n,o=e[0],_=i.blend,c=i.similarity,l=i.color,f=l.substr(4,l.length-5).split(","),i={r:f[0],g:f[1],b:f[2]},d=MovieMasher.Colors.rgb2yuv(i),l=o.canvas.width,i=o.canvas.height,h=0;h<3;h++)f[h]=Number(f[h]);for(a=(s=(i=o.context.getImageData(0,0,l,i)).data).length/4;a--;)r=[MovieMasher.Colors.rgb2yuv(MovieMasher.Filter.rgb_at_index(n=4*a,s))],s[3+n]=MovieMasher.Colors.yuv_blend(r,d,c,_);return o.context.putImageData(i,0,0),e},parameters:[{name:"color",value:"color"},{name:"similarity",value:"similarity"},{name:"blend",value:"blend"}]}),MovieMasher.Filter.register("color",{render:function(e,t,i,r){e=e[0],r=MovieMasher.Filter.create_drawing_like(e,MovieMasher.Filter.label(r)+" "+i.color);return r.context.fillStyle=i.color,r.context.fillRect(0,0,r.canvas.width,r.canvas.height),[r]},parameters:[{name:"color",value:"color"},{name:"size",value:"mm_dimensions"},{name:"duration",value:"mm_duration"},{name:"rate",value:"mm_fps"}]}),MovieMasher.Filter.register("colorchannelmixer",{render:function(e,t,i){for(var r,a,s,n,o,_,c,l,f,d,h,u=e[0],m="rgba".split(""),p=m.length,g=0;g<p;g++)for(a=m[g],n=0;n<p;n++)null===i[r=a+(s=m[n])]&&(i[r]=a===s?1:0);for(f=u.canvas.width,d=u.canvas.height,p=(h=(d=u.context.getImageData(0,0,f,d)).data).length,g=0;g<p;g+=4)o=h[g],_=h[g+1],c=h[g+2],l=h[g+3],h[g]=o*i.rr+_*i.rg+c*i.rb+l*i.ra,h[g+1]=o*i.gr+_*i.gg+c*i.gb+l*i.ga,h[g+2]=o*i.br+_*i.bg+c*i.bb+l*i.ba,h[g+3]=o*i.ar+_*i.ag+c*i.ab+l*i.aa;return u.context.putImageData(d,0,0),e}}),MovieMasher.Filter.register("convolution",{render:function(e,t,i){var r=function(e){for(var t,i,r,a,s={bias:{},rdiv:{},matrix:{}},n=0;n<4;n++){for(t=String(n),s.matrix[a="rgba"[n]]=e[t+"m"].split(" "),r=s.matrix[a].length,i=0;i<r;i++)s.matrix[a][i]=parseInt(s.matrix[a][i]);s.rdiv[a]=e[t+"rdiv"]||1,-1<String(s.rdiv[a]).indexOf("/")?(s.rdiv[a]=s.rdiv[a].split("/"),s.rdiv[a]=parseFloat(s.rdiv[a][0])/parseFloat(s.rdiv[a][1])):s.rdiv[a]=parseFloat(s.rdiv[a]),s.bias[a]=e[t+"bias"]||0}return s}(i),a=e[0],s=a.canvas.width,n=a.canvas.height,o=a.context.getImageData(0,0,s,n).data,i=a.context.createImageData(s,n);return function(e,t,i,r,a){for(var s,n,o,_,c,l,f,d,h=r*a,u=0;u<h;u++)for(s=MovieMasher.Filter.rgb_matrix_from_pixel(u,t,r,a),f=0;f<4;f++){for(_=e.rdiv[d="rgba"[f]],o=e.matrix[d],n=e.bias[d],l=c=0;l<9;l++)c+=s[l][d]*o[l];c=Math.floor(c*_+n+.5),i[4*u+f]=c}}(r,o,i.data,s,n),a.context.putImageData(i,0,0),e}}),MovieMasher.Filter.register("crop",{render:function(e,t,i,r){var a,s,n=i.w||i.out_w,o=i.h||i.out_h,_=t.mm_in_w,c=t.mm_in_h,l=i.x||0,f=i.y||0;return n+o<2?console.error("crop.render invalid output dimensions",i,t,n,o):_&&c?(a=e[0])?(s=MovieMasher.Filter.create_drawing(n=-1===n?_*(o/c):n,o=-1===o?c*(n/_):o,MovieMasher.Filter.label(r)+" "+n+"x"+o+" "+l+","+f,a.container),a.drawings.push(s),s.context.drawImage(a.canvas,l,f,n,o,0,0,n,o)):console.error("crop.render invalid input context",i,t,e):console.error("crop.render invalid input dimensions",i,t,_,c),[s]},parse:function(e,t){e=e[0];return t.in_h=t.mm_in_h=e.canvas.height,t.in_w=t.mm_in_w=e.canvas.width,t.x||(t.x="((in_w - out_w) / 2)"),t.y||(t.y="((in_h - out_h) / 2)"),t}}),MovieMasher.Filter.register("drawbox",{render:function(e,t,i,r){var a=e[0],s=MovieMasher.Util.isnt(i.color)?"black":i.color,n=i.x||0,o=i.y||0,_=i.width||a.canvas.width,i=i.height||a.canvas.height,r=MovieMasher.Filter.create_drawing_like(a,MovieMasher.Filter.label(r)+" "+s+" "+_+"x"+i+" "+n+","+o);return r.context.fillStyle=s,r.context.fillRect(n,o,_,i),a.context.drawImage(r.canvas,0,0),e}}),MovieMasher.Filter.register("drawtext",{render:function(e,t,i,r){var a=e[0],s=MovieMasher.Filter.create_drawing_like(a,MovieMasher.Filter.label(r)+" "+i.fontsize+"px "+i.x+","+i.y+" "+i.fontcolor+" "+i.shadowcolor+" "+i.shadowx+","+i.shadowy);return i.shadowcolor&&(s.context.shadowColor=i.shadowcolor,s.context.shadowOffsetX=i.shadowx||0,s.context.shadowOffsetY=i.shadowy||0,s.context.shadowBlur=0),(r=MovieMasher.Loader.cached_urls[i.fontfile])&&((r=r.getPath(i.text||i.textfile,i.x,Number(i.y)+Number(i.fontsize),i.fontsize)).fill=i.fontcolor,r.draw(s.context)),a.context.drawImage(s.canvas,0,0),e},parse:function(e,t){return t.text_w=0,t.text_h=0,t.mm_fontfamily=function(e){var t="",i=MovieMasher.find(MovieMasher.Constant.font,e);return i?t=i.family||i.label:console.warn("no registered font family with id",e,i),t},t.mm_textfile=function(e){return e},t.mm_fontfile=function(e){var t="",i=MovieMasher.find(MovieMasher.Constant.font,e);return i?t=i.source:console.warn("no registered font url with id",e,i),t},t},parameters:[{name:"fontcolor",value:"#000000"},{name:"shadowcolor",value:"#FFFFFF"},{name:"fontsize",value:"mm_vert(20)"},{name:"x",value:"0"},{name:"y",value:"0"},{name:"shadowx",value:"mm_horz(5)"},{name:"shadowy",value:"mm_vert(5)"},{name:"fontfile",value:"mm_fontfile(com.moviemasher.font.default)"},{name:"textfile",value:"Hello World"}]}),MovieMasher.Filter.register("fade",{render:function(e,t,i,r){e=e[0],r=MovieMasher.Filter.create_drawing_like(e,MovieMasher.Filter.label(r)+" "+t.mm_t);return r.context.globalAlpha=t.mm_t,r.context.drawImage(e.canvas,0,0),r.context.globalAlpha=1,[r]}}),MovieMasher.Filter.register("overlay",{render:function(e,t,i){if(e.length<2)return console.error("overlay.apply with insufficient contexts",e);var r=e[0],a=e[1];return r?a?(r.context.drawImage(a.canvas,i.x,i.y),[r]):console.error("overlay.apply with no top_ctx",e):console.error("overlay.apply with no bot_ctx",e)},parse:function(e,t){return t.overlay_w=e[1].canvas.width,t.overlay_h=e[1].canvas.height,t}}),MovieMasher.Filter.register("scale",{render:function(e,t,i,r){var a,s,n,o,_=i.w||i.width,c=i.h||i.height;return _+c<2?console.error("scale.render invalid output dimensions",i,t,_,c):(a=e[0])?(n=t.mm_in_w,o=t.mm_in_h,s=MovieMasher.Filter.create_drawing(_=-1===_?n*(c/o):_,c=-1===c?o*(_/n):c,MovieMasher.Filter.label(r)+" "+_+"x"+c,a.container),a.drawings.push(s),s.context.drawImage(a.canvas,0,0,n,o,0,0,_,c)):console.error("scale.render invalid input context",i,t,e),[s]},parse:function(e,t){e=e[0];return t.in_h=t.mm_in_h=e.canvas.height,t.in_w=t.mm_in_w=e.canvas.width,t}}),MovieMasher.Filter.register("setsar",{}),Action=function(e,t,i,r){this.player=e,this._redo=t,this._undo=i,this._destroy=r,this.undo_selected_clips=this.redo_selected_clips=Util.copy_array(e.selectedClips),this.undo_selected_effects=this.redo_selected_effects=Util.copy_array(e.selectedEffects),this.redo_add_objects=[],this.undo_delete_objects=[],this.undo_add_objects=[],this.redo_delete_objects=[]},function(e){e.redo=function(){this.player.add_media(this.redo_add_objects),this._redo(),this.player.remove_media(this.redo_delete_objects),this.player.selectedClips=this.redo_selected_clips,this.player.selectedEffects=this.redo_selected_effects,this.player.rebuffer(),this.player.redraw()},e.undo=function(){this.player.add_media(this.undo_add_objects),this._undo(),this.player.remove_media(this.undo_delete_objects),this.player.selectedClips=this.undo_selected_clips,this.player.selectedEffects=this.undo_selected_effects,this.player.rebuffer(),this.player.redraw()},e.destroy=function(){this._destroy&&this._destroy(),delete this._destroy,delete this.player,delete this._redo,delete this._undo,delete this.undo_selected_clips,delete this.redo_selected_clips,delete this.undo_selected_effects,delete this.redo_selected_effects,delete this.redo_add_objects,delete this.undo_delete_objects,delete this.undo_add_objects,delete this.redo_delete_objects}}(Action.prototype),MovieMasher.Action=Action,Audio={buffer_source:function(e){var t=Audio.get_ctx().createBufferSource();return t.buffer=e,t},load:function(e){Loader.load_audio(e)},clip_timing:function(e,t,i){isNaN(t)&&console.error("Audio.clip_timing got NaN for zero_seconds",e);var r={offset:0},i=new TimeRange(e.frame,i,e.frames);return r.start=t+i.seconds,isNaN(r.start)&&console.error("Audio.clip_timing start is NaN",i),r.duration=i.lengthSeconds,e.trim&&(i.frame=e.trim,r.offset=i.seconds),(e=Audio.get_ctx().currentTime)>r.start&&(i=e-r.start,r.start=e,isNaN(r.start)&&console.error("Audio.clip_timing currentTime is NaN"),r.offset+=i,r.duration-=i),r},connect_source:function(e,t,i,r){var a=Audio.get_ctx();e.gainNode=a.createGain(),e.buffer_source.connect(e.gainNode),e.gainNode.connect(a.destination),e.buffer_source.start(t,i,r)},config_gain:function(e,t,i,r,a){var s,n,o,_,c;for(e.cancelScheduledValues(0),_=(c=t.split(",")).length/2,o=0;o<_;o++)n=c[2*o],s=a*c[2*o+1],e[Constant.gain].linearRampToValueAtTime(s,i+n*r)},create_buffer_source:function(){var e;Audio.__buffer_source||(e=Audio.get_ctx(),Audio.__buffer_source=e.createBufferSource(),Audio.__buffer_source.loop=!0,Audio.__buffer_source.buffer=e.createBuffer(2,44100,44100),Audio.__buffer_source.connect(e.destination))},destroy_buffer_source:function(){Audio.__buffer_source&&(Audio.__buffer_source.disconnect(Audio.get_ctx().destination),Audio.__buffer_source=null)},destroy_sources:function(e){for(var t,i=[],r=Audio.sources.length,a=0;a<r;a++)t=Audio.sources[a],e&&-1<e.indexOf(t.clip)?i.push(t):(Audio.disconnect_source(t),delete t.buffer_source);Audio.sources=i},disconnect_source:function(e){var t=Audio.get_ctx();e.buffer_source.disconnect(e.gainNode),e.gainNode.disconnect(t.destination),delete e.gainNode},get_ctx:function(){return Audio.ctx||(window.AudioContext?Audio.ctx=new window.AudioContext:window.webkitAudioContext&&(Audio.ctx=new window.webkitAudioContext)),Audio.ctx},gain_source:function(e){var t;e&&(e.player.muted||!e.player.volume?e.gainNode[Constant.gain].value=0:isNaN(Number(e.clip[Constant.gain]))?(t=Audio.clip_timing(e.clip,Audio.zero_seconds(),e.quantize),Audio.config_gain(e.gainNode,e.clip[Constant.gain],t.start,t.duration,e.player.volume)):e.gainNode[Constant.gain].value=e.clip[Constant.gain]*e.player.volume)},media_url:function(e){var t;switch(e.type){case Constant.video:switch(e.audio){case void 0:t=e.source;break;case"0":break;default:t=e.audio}break;case Constant.audio:t=e.audio||e.url||e.source}return t},start:function(e){Audio.__last_seconds=e,Audio.__sync_seconds=Audio.get_ctx().currentTime,Audio.__playing_start()},stop:function(){Audio.__playing_stop(),Audio.destroy_sources(),Audio.__last_seconds=0,Audio.__sync_seconds=0},source_for_clip:function(e){return Util.array_find(Audio.sources,{clip:e},"clip")},source_from_clip:function(e,t,i){var r,a,s,n=Audio.media_url(t);return n&&Loader.cached_urls[n]&&(r=i.mash.quantize,0<(a=Audio.clip_timing(e,Audio.zero_seconds(),r)).duration&&!isNaN(a.start)&&((s={}).clip=e,s.media=t,s.url=n,s.player=i,s.quantize=r,s.buffer_source=Audio.buffer_source(Loader.cached_urls[n]),Constant.audio===t.type&&t.loops&&(Audio.__buffer_source.loop=!0),Audio.connect_source(s,a.start,a.offset,a.duration),Audio.gain_source(s),Audio.sources.push(s))),s},time:function(){return Audio.__last_seconds+(Audio.get_ctx().currentTime-Audio.__sync_seconds)},zero_seconds:function(){return Audio.__sync_seconds-Audio.__last_seconds},__playing_start:function(){Audio.__playing||(Audio.__playing=!0,Audio.__buffer_source&&Audio.__buffer_source.start(0))},__playing_stop:function(){Audio.__playing&&(Audio.__playing=!1,Audio.__buffer_source&&Audio.__buffer_source.stop())},sources:[],ctx:null,__last_seconds:0,__sync_seconds:0,__playing:!1},MovieMasher.Audio=Audio,Colors={yuv2rgb:function(e){var t,i={};for(t in e)e[t]=parseInt(e[t]);for(t in i.r=e.y+1.4075*(e.v-128),i.g=e.y-.3455*(e.u-128)-.7169*(e.v-128),i.b=e.y+1.779*(e.u-128),i)i[t]=Math.min(255,Math.max(0,Math.floor(i[t])));return i},rgb2hex:function(e){var t=e.r.toString(16),i=e.g.toString(16),e=e.b.toString(16);return"#"+(t=t.length<2?"0"+t:t)+(i=i.length<2?"0"+i:i)+(e=e.length<2?"0"+e:e)},yuv_blend:function(e,t,i,r){for(var a,s,n=0,o=e.length,_=0;_<o;_++)a=e[_].u-t.u,s=e[_].v-t.v,n+=Math.sqrt((a*a+s*s)/65025);return n/=Number(o),1e-4<r?255*Math.min(1,Math.max(0,(n-i)/r)):i<n?255:0},rgb2yuv:function(e){var t,i={};for(t in e)e[t]=parseInt(e[t]);for(t in i.y=.299*e.r+.587*e.g+.114*e.b,i.u=-.168736*e.r+-.331264*e.g+.5*e.b+128,i.v=.5*e.r+-.418688*e.g+-.081312*e.b+128,i)i[t]=Math.floor(i[t]);return i}},MovieMasher.Colors=Colors,Constant={audio:"audio",both:"both",effect:"effect",filter:"filter",font:"font",frame:"frame",freeze:"freeze",gain:"gain",image:"image",merger:"merger",mute_shorthand:"0",mute:"0,0,1,0",property_types:{rgba:{type:String,value:"#000000FF"},rgb:{type:String,value:"#000000"},font:{type:String,value:"com.moviemasher.font.default"},fontsize:{type:Number,value:13},direction4:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"}],value:0},direction8:{type:Number,values:[{id:0,identifier:"top",label:"Top"},{id:1,identifier:"right",label:"Right"},{id:2,identifier:"bottom",label:"Bottom"},{id:3,identifier:"left",label:"Left"},{id:4,identifier:"top_right",label:"Top Right"},{id:5,identifier:"bottom_right",label:"Bottom Right"},{id:6,identifier:"bottom_left",label:"Bottom Left"},{id:7,identifier:"top_left",label:"Top Left"}],value:0},string:{type:String,value:""},pixel:{type:Number,value:0},mode:{type:String,value:"normal",values:[{id:"burn",composite:"color-burn",label:"Color Burn"},{id:"dodge",composite:"color-dodge",label:"Color Dodge"},{id:"darken",composite:"darken",label:"Darken"},{id:"difference",composite:"difference",label:"Difference"},{id:"exclusion",composite:"exclusion",label:"Exclusion"},{id:"hardlight",composite:"hard-light",label:"Hard Light"},{id:"lighten",composite:"lighter",label:"Lighten"},{id:"multiply",composite:"multiply",label:"Multiply"},{id:"normal",composite:"normal",label:"Normal"},{id:"overlay",composite:"overlay",label:"Overlay"},{id:"screen",composite:"screen",label:"Screen"},{id:"softlight",composite:"soft-light",label:"Soft Light"},{id:"xor",composite:"xor",label:"Xor"}]},text:{type:String,value:""}},scaler:"scaler",source:"source",theme:"theme",transition:"transition",video:"video",volume:"volume"},Constant.track_types=[Constant.video,Constant.audio],MovieMasher.Constant=Constant,Defaults={modules:{font:{label:"Blackout Two AM",id:"com.moviemasher.font.default",type:"font",source:"media/font/default.ttf",family:"Blackout Two AM"},merger:{label:"Top Left",id:"com.moviemasher.merger.default",filters:[{id:"overlay",parameters:[{name:"x",value:"0"},{name:"y",value:"0"}]}]},scaler:{label:"Stretch",id:"com.moviemasher.scaler.default",filters:[{id:"scale",parameters:[{name:"width",value:"mm_width"},{name:"height",value:"mm_height"}]},{id:"setsar",parameters:[{name:"sar",value:"1"},{name:"max",value:"1"}]}]}},module_for_type:function(e,t){e=Defaults.modules[e];return e=e&&t&&e.id!==t?null:e},module_from_type:function(e){var t={},i=Defaults.module_for_type(e);return i?t.id=i.id:console.error("Defaults.module_from_type not found",e),t}},MovieMasher.Defaults=Defaults,Filter={registered:{},find:function(e){return MovieMasher.find(Constant.filter,e)},load:function(e){var t,i=Filter.find(e);return i&&((t=Filter.registered[e])||Loader.load_filter(i.source)),t},create_drawing:function(e,t,i,r){var a={drawings:[]};return a.container=r,a.label=i,a.canvas=document.createElement("canvas"),a.context=a.canvas.getContext("2d"),1<=e&&(a.canvas.width=e),1<=t&&(a.canvas.height=t),a.container&&(a.span=document.createElement("span"),a.span.setAttribute("alt",a.label),a.container.appendChild(a.span),a.span.appendChild(a.canvas)),a},create_drawing_like:function(e,t){t=Filter.create_drawing(e.canvas.width,e.canvas.height,t,e.container);return e.drawings.push(t),t},destroy_drawing:function(e){for(var t in e.container&&(e.container.removeChild(e.span)||console.error("could not find span in container"),e.span.removeChild(e.canvas)||console.error("could not find canvas in span")),e)e[t]=null},label:function(e){return e.description||e.id},register:function(e,t){Filter.registered[e]=t},rgb_at_pixel:function(e,t){e=Filter.index_from_pixel(e);return Filter.rgb_at_index(e,t)},array_from_rgb:function(e){return[e.r,e.g,e.b,e.a]},rgb_at_index:function(e,t){var i=null;return i=0<=e&&e<=t.length-4?{r:t[e],g:t[e+1],b:t[e+2],a:t[e+3]}:i},pixel_from_point:function(e,t){return e.y*t+e.x},point_from_pixel:function(e,t){var i={x:0,y:0};return i.x=e%t,i.y=Math.floor(e/t),i},pixel_from_index:function(e){return e/4},index_from_pixel:function(e){return 4*e},point_from_index:function(e,t){e=Filter.pixel_from_index(e);return Filter.point_from_pixel(e,t)},safe_pixel:function(e,t,i,r,a){e=Filter.point_from_pixel(e,r);return e.x=Math.max(0,Math.min(r-1,e.x+t)),e.y=Math.max(0,Math.min(a-1,e.y+i)),Filter.pixel_from_point(e,r)},safe_pixels:function(e,t,i,r){r=r||3;for(var a,s,n=[],o=Math.floor(r/2),_=0;_<r;_++)for(a=0;a<r;a++)s=Filter.safe_pixel(e,a-o,_-o,t,i),n.push(s);return n},rgb_matrix_from_index:function(e,t,i,r,a){e=Filter.pixel_from_index(e);return Filter.rgb_matrix_from_pixel(e,t,i,r,a)},rgb_matrix_from_pixel:function(e,t,i,r,a){for(var s=Filter.safe_pixels(e,i,r,a),n=s.length,o=0;o<n;o++)s[o]=Filter.rgb_at_pixel(s[o],t);return s}},MovieMasher.Filter=Filter;var _opentype=require("opentype"),_opentype2=_interopRequireDefault(_opentype),_scriptjs=require("scriptjs"),_scriptjs2=_interopRequireDefault(_scriptjs);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Loader={load_audio:function(t){var e;Loader.requested_urls[t]||Loader.cached_urls[t]||((e=new XMLHttpRequest).open("GET",t,!0),e.responseType="arraybuffer",e.onload=function(){Audio.get_ctx().decodeAudioData(e.response,function(e){Loader.cached_urls[t]=e,delete Loader.requested_urls[t],Players.draw_delayed()},function(){console.error("problem decoding audio",t)})},(Loader.requested_urls[t]=e).send())},load_filter:function(e){Loader.requested_urls[e]||Loader.cached_urls[e]||(Loader.requested_urls[e]=e,(0,_scriptjs2.default)(e,function(){delete Loader.requested_urls[e],Loader.cached_urls[e]=!0,Players.draw_delayed()}))},load_font:function(i){Loader.requested_urls[i]||Loader.cached_urls[i]||(Loader.requested_urls[i]=i,_opentype2.default.load(i,function(e,t){e?console.error("could not find registered font with url",i,e):(Loader.cached_urls[i]=t,delete Loader.requested_urls[i],Players.draw_delayed())}))},load_image:function(e){Loader.requested_urls[e]||Loader.cached_urls[e]||(Loader.requested_urls[e]=new Image,Loader.requested_urls[e].onload=function(){Loader.cached_urls[e]=Loader.requested_urls[e],delete Loader.requested_urls[e],Players.draw_delayed()},Loader.requested_urls[e].crossOrigin="Anonymous",Loader.requested_urls[e].src=e)},load_urls_of_type:function(e){var t,i=!1;for(t in e)if(!Loader.cached_urls[t]&&!Loader.requested_urls[t])switch(i=!0,e[t]){case Constant.font:Loader.load_font(t);break;case Constant.image:Loader.load_image(t);break;case Constant.filter:Loader.load_filter(t);break;case Constant.audio:Loader.load_audio(t);break;default:console.error("cannot load media of unsupported type",e[t],t)}return i},loaded_urls_of_type:function(e){var t,i=!0;for(t in e)if(!Loader.cached_urls[t]){i=!1;break}return i},cached_urls:{},requested_urls:{}},setInterval(function(){for(var e,t=Players.instances.length,i=Loader.cached_urls,r=0;r<t;r++)i=Players.instances[r].deleteable_urls(i);for(e in i)delete Loader.cached_urls[e],delete Loader.requested_urls[e]},2e3),MovieMasher.Loader=Loader,Mash={clip_from_media:function(e){var t,i,r,a,s={id:e.id};if(e.properties)for(t in e.properties)a=e.properties[t],Util.isnt(a.value)?(i=a.type)&&(r=Constant.property_types[i])&&(Util.isnt(r.value)?r.type&&(s[t]=new r.type):s[t]=r.value):s[t]=a.value;return s},clip_has_audio:function(e,t){var i=!1;switch(t.type){case Constant.video:i=!!Audio.media_url(t);break;case Constant.audio:i=t.url||t.source}if(i)switch(e[Constant.gain]){case Constant.mute:case Constant.mute_shorthand:i=!1}return i},clip_time:function(e,t,i,r,a){var s;(s=i.copyTime()).subtract(new TimeRange(e.frame,r));i=new TimeRange(e.frames,r);switch(s.min(i),a&&(s.frame+=e.speed?Math.ceil(e.speed):1),t.type){case Constant.video:e.trim&&s.add(new TimeRange(e.trim,r)),e.speed&&s.divide(e.speed,"ceil");break;case Constant.audio:e.trim&&s.add(new TimeRange(e.trim,r))}return s},effect_clips:function(e){for(var t,i=[],r=e.length,a=0;a<r;a++)t=e[a],Util.isarray(t.effects)&&t.effects.length&&(i=i.concat(t.effects));return i},init_clip:function(e,t,i,r){if(r=r||0,t&&i&&e&&!Mash.init_media(i)&&(Mash.is_modular_media(i)&&Mash.init_module(i.type,t,i),Constant.effect!==i.type)){switch(Util.isnt(t.track)&&(t.track=r),Util.isnt(t.frame)&&(t.frame=0),i.type){case Constant.video:case Constant.audio:Util.isnt(t[Constant.gain])&&(t[Constant.gain]=1),Util.isnt(t.frames)&&(t.frames=new TimeRange(i.duration,1).scale(e.quantize,"floor").frame),Util.isnt(t.trim)&&(t.trim=0);break;default:Util.isnt(t.frames)&&(t.frames=new TimeRange(Option.mash[i.type+"_seconds"],1).scale(e.quantize).frame)}switch(i.type){case Constant.transition:case Constant.audio:break;default:Util.isnt(t.scaler)&&(t.scaler=i.scaler||Defaults.module_from_type(Constant.scaler)),Util.isnt(t.merger)&&(t.merger=i.merger||Defaults.module_from_type(Constant.merger)),Util.isnt(t.effects)&&(t.effects=i.effects||[]),i=t.scaler,Mash.init_module(Constant.scaler,i,Mash.media_search(Constant.scaler,i.id,e)),i=t.merger,Mash.init_module(Constant.merger,i,Mash.media_search(Constant.merger,i.id,e));for(var a=t.effects.length,s=0;s<a;s++)i=t.effects[s],Mash.init_module(Constant.effect,i,Mash.media_search(Constant.effect,i.id,e))}}},init_mash:function(e){var t,i,r,a,s,n,o,_,c,l,f,d;for(Util.copy_ob_scalars(Option.mash.default,e,!0),e.quantize=e.quantize?parseInt(e.quantize):1,Util.isnt(e.id)&&(e.id=Util.uuid()),t={},Util.isarray(e.media)||(e.media=[]),f=Constant.track_types.length,d=0;d<f;d++)if(n=Constant.track_types[d],Util.isarray(e[n])||(e[n]=[]),_=(a=e[n]).length){for(o=0;o<_;o++)if(l=(s=Mash.init_track(a[o],o)).clips.length){for(c=0;c<l;c++)r=s.clips[c],i=Mash.media(e,r),Mash.init_clip(e,r,i,o);Mash.media_count_for_clips(e,s.clips,t)}}else a.push(Mash.init_track(n,0));for(n in t)t[n]=t[n].count;return t},init_media:function(e){var t=!Util.isob(e);if(!t)switch(Util.isnt(e.id)&&(e.id=Util.uuid()),e.type){case Constant.video:Util.isnt(e.fps)&&(e.fps=10),Util.isnt(e.duration)&&(e.duration=0),Util.isnt(e.begin)&&(e.begin=1),Util.isnt(e.pattern)&&(e.pattern="%.jpg"),Util.isnt(e.increment)&&(e.increment=1),Util.isnt(e.zeropadding)&&(e.zeropadding=String(e.begin+e.increment*Math.floor(e.fps*e.duration)).length);break;case Constant.transition:Util.isnt(e.to)&&(e.to={}),Util.isnt(e.from)&&(e.from={}),Util.isnt(e.to.scaler)&&(e.to.scaler=Defaults.module_from_type(Constant.scaler)),Util.isnt(e.to.merger)&&(e.to.merger=Defaults.module_from_type(Constant.merger)),Util.isnt(e.from.scaler)&&(e.from.scaler=Defaults.module_from_type(Constant.scaler)),Util.isnt(e.from.merger)&&(e.from.merger=Defaults.module_from_type(Constant.merger))}return t&&console.error("init_media got invalid media",e),t},init_module:function(e,t,i){if(!i)return console.error("could not find media for module",t);if(i.properties)for(var r in i.properties)Util.isnt(t[r])&&(t[r]=i.properties[r].value)},init_track:function(e,t){return(e=!Util.isob(e)?{type:e}:e).index=t,Util.isarray(e.clips)||(e.clips=[]),e},is_modular_clip:function(e,t){return Mash.is_modular_media(Mash.media(e,t))},is_modular_media:function(e){var t=!1;if(Util.isob(e)&&!Util.isnt(e.type))switch(e.type){case Constant.image:case Constant.audio:case Constant.video:case"frame":break;default:t=!0}return t},is_visual_media:function(e){var t=!1;if(Util.isob(e))switch(e.type){case Constant.image:case Constant.video:case Constant.transition:case Constant.theme:t=!0}return t},length_of_clips:function(e){var t=0;return t=Util.isarray(e)&&e.length?(e=e[e.length-1]).frame+e.frames:t},loaded_range:function(e,t,i){t=Mash.urls_for_clips(e,Mash.range_clips(e,t,i),t);return Loader.loaded_urls_of_type(t)},max_frames_for_clip:function(e,t,i){var r=0;switch(t.type){case Constant.audio:case Constant.video:r=Math.floor(t.duration*i)-e.trim}return r},max_trim_for_clip:function(e,t,i){var r=0;switch(t.type){case Constant.audio:case Constant.video:r=Math.floor(t.duration*i)-Option.mash.minframes}return r},media:function(e,t){return Util.array_find(e.media,t)},media_count_for_clips:function(e,t,i){var r,a,s,n,o,_,c,l,f;if(Util.isob(i)&&Util.isarray(t))for(n=t.length,s=0;s<n;s++)if((r=t[s])||console.error("media_count_for_clips",t),Mash.media_reference(e,r.id,i),f=i[r.id])if(a=f.media){if(Mash.is_modular_media(a))for(_=(l=Mash.properties_for_media(a,Constant.font)).length,o=0;o<_;o++)c=r[l[o]],Mash.media_reference(e,c,i,Constant.font);switch(a.type){case Constant.transition:Mash.media_merger_scaler(e,a.to,i),Mash.media_merger_scaler(e,a.from,i);break;case Constant.effect:case Constant.audio:break;default:Mash.media_merger_scaler(e,r,i),Mash.media_count_for_clips(e,r.effects,i)}}else console.error("could not find media",r.id,f);else console.error("could not find reference")},media_for_clips:function(e,t,i){var r,a,s={},n=[];if(!Util.isnt(t))for(a in Util.isob(i)&&(s[i.id]={media:i,count:1}),Util.isarray(t)||(t=[t]),Mash.media_count_for_clips(e,t,s),s)(r=s[a]).media?n.push(r.media):console.error("could not find media referenced in mash",a,r.count);return n},media_merger_scaler:function(e,t,i){Util.isob(t)&&(Util.isob(t[Constant.merger])&&Mash.media_reference(e,t[Constant.merger].id,i,Constant.merger),Util.isob(t[Constant.scaler])&&Mash.media_reference(e,t[Constant.scaler].id,i,Constant.scaler))},media_range:function(e,t,i,r,a){return TimeRange.fromTimes(Mash.clip_time(e,t,i,r),Mash.clip_time(e,t,i.endTime,r,a))},media_reference:function(e,t,i,r){i[t]?i[t].count++:(i[t]={},i[t].count=1,i[t].media=Mash.media_search(r,t,e))},media_search:function(e,t,i){var r=null;return r=!Util.isnt(t)?(r=(r=i?Mash.media(i,t):r)||MovieMasher.find(e,t))||Defaults.module_for_type(e):r},module_clips:function(e){for(var t,i=Mash.visual_clips(e),r=Mash.effect_clips(i),a=i.length,s=0;s<a;s++)t=i[s],Mash.is_modular_clip(e,t)&&r.push(t);return r},modules_reference_media:function(e,t){var i,r,a,s,n,o,_,c,l=Mash.module_clips(e);if(t=Util.isob(t)?t.id:t)for(a=l.length,r=0;r<a;r++){if((c=l[r]).scaler&&(i=t===c.scaler.id),!(i=c.merger?i||t===c.merger.id:i)&&(_=Mash.media(e,c)))for(o=(s=Mash.properties_for_media(_,Constant.font)).length,n=0;n<o&&!(i=t===c[s[n]]);n++);if(i)break}return i},properties_for_media:function(e,t){var i,r=[];if(!Util.isnt(t)&&Util.isob(e)&&Util.isob(e.properties))for(i in e.properties)t===e.properties[i].type&&r.push(i);return r},range_clips:function(e,t,i){t=t.copyTimeRange();for(var r,a,s,n,o,_,c,l,f=[],d=new TimeRange(0,e.quantize,1),h=Constant.track_types.length,u=0;u<h;u++)if((r=Constant.track_types[u])!==Constant.audio||i)for(_=(a=e[r]).length,o=0;o<_;o++)for(l=(s=a[o]).clips.length,c=0;c<l;c++)n=s.clips[c],d.frame=n.frame,d.frames=n.frames,d.intersection(t)&&f.push(n);return f},recalc_clips:function(e){1<e.length&&e.sort(Util.sort_by_frame)},recalc_track:function(e,t){Constant.audio===t.type||t.index?Mash.recalc_clips(t.clips):Mash.recalc_video_clips(e,t.clips)},recalc_video_clips:function(e,t){for(var i,r,a=0,s=t.length,n=0;n<s;n++)r=t[n],i=Mash.media(e,r),n&&Constant.transition===i.type&&(a-=r.frames),r.frame=a,Constant.transition!==i.type&&(a+=r.frames);Mash.recalc_clips(t)},track_for_clip:function(e,t,i){i=i||Mash.media(e,t);for(var r,a=0,s=e[Constant.audio===i.type?Constant.audio:Constant.video],n=Util.isnt(t.track)?s.length:(a=t.track)+1;a<n;a++)if(-1<(r=s[a]).clips.indexOf(t))return r},urls_for_clip:function(e,t,i,r){var a,s,n,o,_,c,l=e.quantize;if(Util.isob(r)||(r={}),t&&(t[Constant.merger]&&(a=Mash.media_search(Constant.merger,t[Constant.merger].id,e),Mash.urls_for_media_filters(a,r)),t[Constant.scaler]&&(a=Mash.media_search(Constant.scaler,t[Constant.scaler].id,e),Mash.urls_for_media_filters(a,r)),a=Mash.media(e,t))){switch(a.type){case"frame":case Constant.video:r.image||(r.image={}),Mash.urls_for_video_clip(t,a,i,l,r.image);case Constant.audio:Mash.clip_has_audio(t,a)&&(r.audio||(r.audio={}),r.audio[Audio.media_url(a)]=!0);break;case Constant.image:r[a.type]||(r[a.type]={}),r[a.type][a.url||a.source]=!0;break;default:if(Mash.urls_for_media_filters(a,r),n=(_=Mash.properties_for_media(a,Constant.font)).length)for(s=0;s<n;s++)o=_[s],(c=Mash.media_search(Constant.font,t[o],e))?c.source&&(r.font||(r.font={}),r.font[c.source]=!0):console.warn("could not find font",t[o])}if(Mash.is_visual_media(a)&&Util.isarray(t.effects)&&t.effects.length)for(n=t.effects.length,s=0;s<n;s++)Mash.urls_for_clip(e,t.effects[s],i,r)}return r},urls_for_clips:function(e,t,i,r){return Mash.urls_of_type(Mash.urls_for_clips_by_type(e,t,i),r)},urls_for_clips_by_type:function(e,t,i){i=i.copyTimeRange();for(var r,a={},s=t.length,n=0;n<s;n++)r=t[n],Mash.urls_for_clip(e,r,i,a);return a},urls_for_media_filters:function(e,t){var i,r,a,s;if(Util.isob(e)&&Util.isob(t)&&e.filters)for(r=e.filters.length,i=0;i<r;i++)a=e.filters[i],(s=Filter.find(a.id))?(t[Constant.filter]||(t[Constant.filter]={}),t[Constant.filter][s.source]=!0):console.warn("filter not registered",a.id)},urls_for_video_clip:function(e,t,i,r,a){a=a||{};var s,n,o,_,c=1<i.frames;i=Mash.media_range(e,t,i,r,c);var l=new TimeRange(Math.floor(Number(t.duration)*Number(t.fps)),t.fps),f=l.frame,d=i.copyTimeRange();for(d.minLength(l),_=d.end,o=d.frame;o<=_;o++)(l=new TimeRange(o,d.fps)).scale(t.fps),o!==d.frame&&n===l.frame||(n=l.frame,n=Math.min(n,f-1),s=String(Math.min(n,f)*t.increment+t.begin),t.zeropadding&&(s=Util.pad(s,t.zeropadding,"0")),a[(t.url+t.pattern).replace("%",s)]=!0);return a},urls_of_type:function(e,t){var i,r,a,s={};for(i in e){switch(a=!0,t){case Constant.audio:a=i===Constant.audio;break;case Constant.video:a=i!==Constant.audio}if(a)for(r in e[i])s[r]=i}return s},visual_clips:function(e){for(var t,i=[],r=e.video.length,a=0;a<r;a++)t=e.video[a],Util.isarray(t.clips)&&t.clips.length&&(i=i.concat(t.clips));return i}},MovieMasher.Mash=Mash,Option={mash:{minframes:1,quantize:10,transition_seconds:1,frame_seconds:2,image_seconds:2,theme_seconds:3,default:{label:"Untitled Mash",quantize:1,backcolor:"rgb(0,0,0)"}},player:{autoplay:0,buffertime:10,fps:30,loop:1,minbuffertime:1,unbuffertime:1,volume:.75,position_precision:3},set:function(e){Util.copy_keys_recursize(e,Option)},timeline:{hscrollpadding:20}},MovieMasher.Option=Option,Player=function(e){Util.isob(e)||(e={});var t,i,r={};for(i in Util.copy_ob_scalars(Option.player,e),this.__drawing={drawings:[]},this.__load_timer=null,this.__moving=!1,this.__muted=!1,this.__paused=!0,this.__stalling=!1,this.__minbuffertime=new TimeRange(e.minbuffertime,1),this.__unbuffertime=new TimeRange(e.unbuffertime,1),this.__buffertime=new TimeRange(e.buffertime,1),this.__time=new TimeRange(0,1),this.__time_drawn=new TimeRange(0,1),e)switch(t=e[i],i){case"mash":r=t;case"minbuffertime":case"unbuffertime":case"buffertime":case"fps":continue;default:this[i]=t}this.fps=e.fps,this.mash=r},function(pt){var dp=Object.defineProperty;dp(pt,"action_index",{get:function(){return this.__action_index}}),dp(pt,"autoplay",{get:function(){return this.__autoplay},set:function(e){this.__autoplay=e}}),dp(pt,"buffertime",{get:function(){return this.__buffertime.seconds},set:function(e){this.__buffertime=TimeRange.fromSeconds(e,this.__fps)}}),dp(pt,"canvas_context",{get:function(){return this.__drawing.context},set:function(e){this.__drawing.context=e,this.__drawing.canvas=e?e.canvas:null,this.__mash&&(this.__draw_context(),this.redraw())}}),dp(pt,"canvas_container",{get:function(){return this.__drawing.container},set:function(e){this.__drawing.container=e}}),dp(pt,"currentTime",{get:function(){return this.__time.seconds},set:function(e){this.time=TimeRange.fromSeconds(e,this.__fps)}}),dp(pt,"duration",{get:function(){return this.__mash_length?Number(this.__mash_length)/Number(this.__mash.quantize):0}}),dp(pt,"fps",{get:function(){return this.__fps},set:function(e){(e=e&&Math.round(Number(e)))&&this.__fps!==e&&(this.__fps=e,this.__time.scale(this.__fps),this.__minbuffertime.scale(this.__fps),this.__unbuffertime.scale(this.__fps),this.__buffertime.scale(this.__fps),this.__time_drawn.scale(this.__fps))}}),dp(pt,"frame",{get:function(){return this.__time.frame},set:function(e){this.time=new TimeRange(e,this.__fps)}}),dp(pt,"frames",{get:function(){return Math.round(Number(this.__mash_length)/Number(this.__mash.quantize)*Number(this.__time.fps))}}),dp(pt,"loop",{get:function(){return this.__loop},set:function(e){this.__loop=e}}),dp(pt,"mash",{get:function(){return this.__mash},set:function(e){this.paused=!0,this.__action_index=-1,this.__action_stack=[],this.__selected_effects=[],this.__mash=e||{},this.__media_references=Mash.init_mash(this.__mash),this.selectedClips=[],this.mash_length_changed(),this.rebuffer(),this.redraw(),this.__autoplay&&(this.paused=!1)}}),dp(pt,"minbuffertime",{get:function(){return this.__minbuffertime.seconds},set:function(e){this.__minbuffertime=TimeRange.fromSeconds(e,this.__fps)}}),dp(pt,"muted",{get:function(){return this.__muted},set:function(e){this.__muted=e,this.__moving&&this.__adjust_gain(Mash.range_clips(this.__mash,this.__time,!0))}}),dp(pt,"paused",{get:function(){return this.__paused},set:function(e){var t;this.__mash_length||(e=!0),this.__paused!==e&&(this.__paused=e,this.__paused?(this.__set_moving(!1),this.__buffer_timer&&(clearInterval(this.__buffer_timer),this.__buffer_timer=0),Players.stop_playing()):(Players.start_playing(this),this.__buffer_timer||((t=this).__buffer_timer=setInterval(function(){t.rebuffer()},2e3)),this.rebuffer(),this.redraw()),this.__set_stalling(!this.__moving&&!this.__paused))}}),dp(pt,"position",{get:function(){var e,t=0;return t=this.__time.frame&&(e=this.duration)&&1!==(t=this.__time.seconds/e)?parseFloat(t.toFixed(this.position_precision)):t},set:function(e){e=new TimeRange(this.duration*e,1);e.scale(this.__fps),this.time=e}}),dp(pt,"position_step",{get:function(){return parseFloat("0."+"0".repeat(this.position_precision-1)+"1")}}),dp(pt,"selectedClip",{get:function(){return 1===this.__selected_clips.length?this.__selected_clips[0]:null},set:function(e){var t=[];Util.isob(e)&&!Util.isempty(e)&&t.push(e),this.selectedClips=t}}),dp(pt,"selectedClipOrMash",{get:function(){return this.selectedClip||this.__mash}}),dp(pt,"selectedClips",{get:function(){return this.__selected_clips},set:function(e){var t,i,r,a,s,n;if((e=!Util.isob(e)?[]:e).length){for(n={},s=e.length,a=0;a<s;a++)if(r=e[a],i=Mash.media(this.__mash,r)){switch(t=i.type){case Constant.audio:break;case Constant.effect:continue;default:t="video-"+(r.track||0)}n[t]||(n[t]=[]),n[t].push(r)}else console.error("no media for selected clip",r);for(t in n){e=n[t];break}}this.__selected_clips=e,this.selectedEffects=!1,this.__pristine_clip=Util.copy_ob_scalars(this.selectedClipOrMash),this.selectedClipOrMash.scaler&&(this.__pristine_clip.scaler=Util.copy_ob_scalars(this.selectedClipOrMash.scaler)),this.selectedClipOrMash.merger&&(this.__pristine_clip.merger=Util.copy_ob_scalars(this.selectedClipOrMash.merger))}}),dp(pt,"selectedEffect",{get:function(){return 1===this.__selected_effects.length?this.__selected_effects[0]:null},set:function(e){this.selectedEffects=Util.isob(e)?[e]:[]}}),dp(pt,"selectedEffects",{get:function(){return this.__selected_effects},set:function(e){var t,i,r,a,s,n;if((e=!Util.isarray(e)?[]:e).length&&this.__selected_clips.length<2){if(s=[],(n=this.selectedClip)&&Util.isarray(n.effects))for(r=e.length,i=0;i<r;i++)t=e[i],(a=Mash.media(this.__mash,t))&&Constant.effect===a.type&&-1<n.effects.indexOf(t)&&s.push(t);e=s}this.__selected_effects=e,this.__pristine_effect=Util.copy_ob_scalars(this.selectedEffect)}}),dp(pt,"stalling",{get:function(){return this.__stalling}}),dp(pt,"time",{get:function(){return this.__time},set:function(e){e=TimeRange.fromSomething(e),e=this.__limit_time(e);this.__time.isEqualToTime(e)||this.__changed_mash_or_time(e)}}),dp(pt,"unbuffertime",{get:function(){return this.__unbuffertime.seconds},set:function(e){this.__unbuffertime=TimeRange.fromSeconds(e,this.__fps)}}),dp(pt,"volume",{get:function(){return this.__gain},set:function(e){this.__gain=e,this.__moving&&this.__adjust_gain(Mash.range_clips(this.__mash,this.__time,!0))}}),pt.add=function(e,t,i,r){var a;return Mash.init_media(e)||(t=t||(Mash.is_visual_media(e)?Constant.video:e.type),r=r||0,i=i||0,(a=Mash.clip_from_media(e))||console.error("add got no clip from media",a,e),Mash.init_clip(this.__mash,a,e,r),(r=Constant.effect===t?this.__action_effect_add(a,i):Constant.audio===t||r?this.__action_track_add(e.type,a,r,i):this.__action_video_add(a,r,i))&&(i=Mash.media_for_clips(this.__mash,a,e),r.redo_add_objects=i,r.undo_delete_objects=i,Constant.effect===e.type?r.redo_selected_effects=[a]:r.redo_selected_clips=[a],this.__action_add(r))),a},pt.add_media=function(e){for(var t,i,r=(e=!Util.isarray(e)?[e]:e).length,a=0;a<r;a++)i=e[a],t=Util.isob(i)?i.id:i,this.__media_references[t]||(this.__media_references[t]=0,Util.array_find(this.__mash.media,i)||this.__mash.media.push(i)),this.__media_references[t]++},pt.addTrack=function(e){this.__action_add(new Action(this,function(){this.player.__track_create(e)},function(){this.player.__track_delete(e)}))},pt.can=function(e){var t=!1,i=this.__selected_clips.length;switch(e){case"undo":t=-1<this.__action_index;break;case"redo":t=this.__action_index<this.__action_stack.length-1;break;case"adjust":t=(t=0<i)&&0<this.__selected_clips[0].track;break;case"copy":t=0<i;break;case"cut":case"remove":t=this.__selected_clips.length;break;case"split":t=(t=1===i)&&this.__canSplitAtTime(this.__selected_clips[0],this.__time);break;case"freeze":t=(t=(t=0<i)&&Constant.video===Mash.media(this.__mash,this.__selected_clips[0]).type)&&this.__canSplitAtTime(this.__selected_clips[0],this.__time)}return t},pt.change=function(e,t){if(e&&e.length){var i,r="change-property",a=t?this.selectedEffect:this.selectedClipOrMash;if(t||this.selectedClip||Util.isnt(a[e])&&(a=null),a)if(-1<this.__action_index&&this.__action_index===this.__action_stack.length-1&&Util.keys_found_equal({id:r,target:a,property:e},this.__action_stack[this.__action_index]))(i=this.__action_stack[this.__action_index]).value=Util.ob_property(a,e),i._redo(),this.__changed_mash_or_time();else{var s,n=t?this.__pristine_effect:this.__pristine_clip,o=function(){this.set_property(this.orig_value)},_=function(){this.set_property(this.value)},t=!1;switch((t=(t=(s=Mash.media(this.__mash,a))&&Mash.is_modular_media(s)?-1<Mash.properties_for_media(s,Constant.font).indexOf(e)?Constant.font:null:t)||(".id"===e.substr(-3)?e.substr(0,e.length-3):null))&&(o=function(){this.change_data(this.orig_value,!0)},_=function(){this.change_data(this.value)}),i=new Action(this,_,o),e){case"frames":i.max=Mash.max_frames_for_clip(a,s,this.__mash.quantize),i.set_property=function(e){e=Math.max(Option.mash.minframes,e),this.max&&(e=Math.min(this.max,e)),Util.set_ob_property(this.target,this.property,e),Mash.recalc_track(this.player.mash,Mash.track_for_clip(this.player.mash,this.target)),this.player.mash_length_changed()};break;case"trim":i.orig_length=Util.ob_property(a,"frames"),i.max=Mash.max_trim_for_clip(a,s,this.__mash.quantize),i.set_property=function(e){e=Math.max(0,e),this.max&&(e=Math.min(this.max,e)),Util.set_ob_property(this.target,this.property,e),e=this.orig_length-(e-this.orig_value),Util.set_ob_property(this.target,"frames",e),Mash.recalc_track(this.player.mash,Mash.track_for_clip(this.player.mash,this.target)),this.player.mash_length_changed()};break;case Constant.gain:i.set_property=function(e){Util.set_ob_property(this.target,this.property,e),Audio.gain_source(Audio.source_for_clip(this.target))};break;default:i.set_property=function(e){Util.set_ob_property(this.target,this.property,e)}}i.target=a,i.id=r,i.property=e,i.value=Util.ob_property(a,e),i.orig_value=Util.ob_property(n,e),t&&(i.is_id=t,i.last_value=i.orig_value,i.change_data=function(e,t){var i=Mash.media_search(this.is_id,e,this.player.mash);if(!i)return console.error("could not find "+this.is_id+" for "+e);this.player.add_media(i),Constant.font===this.is_id?this.set_property(e):this.target[this.is_id]=t?n[this.is_id]:Mash.clip_from_media(i),this.player.remove_media(Mash.media_search(this.is_id,this.last_value,this.player.mash)),this.last_value=e}),this.__action_add(i)}}},pt.changeEffect=function(e){this.change(e,!0)},pt.deleteable_urls=function(e){var t,i={};for(t in e)this.__needed_urls[t]||(i[t]=!0);return i},pt.destroy=function(){this.mash=null,this.canvas_context=null},pt.did=function(){},pt.mash_length_changed=function(){for(var e,t,i,r,a,s=0,n=Constant.track_types.length,o=0;o<n;o++)for(i=Constant.track_types[o],t=(r=this.__mash[i]).length,e=0;e<t;e++)s=Math.max(s,Mash.length_of_clips(r[e].clips));this.__mash_length!==s&&(this.__mash_length=s,(a=new TimeRange(this.__mash_length,this.__mash.quantize)).scale(this.__fps,"floor"),this.__mash_frames=a.frame,this.frame=Math.max(0,Math.min(this.__mash_frames-1,this.__time.frame)))},pt.media=function(e){return Mash.media(this.__mash,e)},pt.move=function(e,t,i,r){var a;Util.isnt(e,t)||(Util.isarray(e)||(e=[e]),Util.isob.apply(Util,e)&&(r=r||0,i=i||0,Constant.effect===t?-2<(i=Util.index_after_removal(i,e,this.selectedClipOrMash.effects))&&(a=this.__action_effects_move(i,e,this.selectedClipOrMash.effects)):Constant.audio===t||r?a=this.__action_clips_move(t,r,i,e):-2<(i=Util.index_after_removal(i,e,this.__mash[t][r].clips))&&(a=this.__action_video_move(r,i,e)),a&&this.__action_add(a)))},pt.pause=function(){this.paused=!0},pt.play=function(){this.paused=!1},pt.rebuffer=function(){var e,t,i,r,a,s,n,o,_={},c=[];if(this.__mash&&(t=this.__audio_is_on(),(i=!(i=this.__paused?this.__time.copyTime():new TimeRange(this.__time.frame,this.__time.fps,this.__buffertime.frame)).intersection(new TimeRange(0,this.__mash.quantize,this.__mash_length))?null:i)&&(s=Mash.range_clips(this.__mash,i,t),_=Mash.urls_for_clips(this.__mash,s,i,t?Constant.both:Constant.video),Loader.load_urls_of_type(_),t))){for(o=s.length,n=0;n<o;n++)a=s[n],r=Mash.media(this.__mash,a),Mash.clip_has_audio(a,r)&&(Audio.source_for_clip(a)||(Audio.source_from_clip(a,r,this),e=!0),c.push(a));c.length&&Audio.destroy_sources(c),e&&Players.draw_delayed()}this.__needed_urls=_},pt.redo=function(e){this.__action_index<this.__action_stack.length-1&&(this.__action_index++,this.__action_stack[this.__action_index].redo(),this.did(e),this.__changed_mash_or_time())},pt.redraw=function(){var e,t,i,r;this.__drawing.context&&(e=this.__audio_is_on(),t=Mash.range_clips(this.__mash,this.__time,e),r=Mash.urls_for_clips_by_type(this.__mash,t,this.__time),i=Loader.loaded_urls_of_type(Mash.urls_of_type(r,Constant.video)),r=!e||Loader.loaded_urls_of_type(Mash.urls_of_type(r,Constant.audio)),(i&&r)!==this.__moving&&(this.__moving?this.__set_moving(!1):!this.__paused&&Mash.loaded_range(this.__mash,this.__time_drawn.copyTime(this.__buffertime.frame),e)&&this.__set_moving(!0)),i?(this.__time_drawn=this.__time.copyTime(),this.__draw_request(t)):this.__paused&&this.rebuffer())},pt.remove=function(e,t,i){var r;Util.isnt(e,t)||(Util.isarray(e)||(e=[e]),Util.isob.apply(Util,e)&&(i=i||0,Constant.effect===t?(r=this.__action_effects_remove(e,this.selectedClipOrMash.effects)).redo_selected_effects=[]:(r=Constant.audio===t||i?this.__action_clips_remove(t,i,e):this.__action_video_remove(i,e)).redo_selected_clips=[],r&&(e=Mash.media_for_clips(this.__mash,e),r.undo_add_objects=e,r.redo_delete_objects=e,this.__action_add(r))))},pt.remove_media=function(e){for(var t,i,r=(e=!Util.isarray(e)?[e]:e).length,a=0;a<r;a++)i=e[a],t=Util.isob(i)?i.id:i,this.__media_references[t]?this.__media_references[t]--:console.warn("remove_media unreferenced media",t),this.__media_references[t]||(-1===Util.array_delete_ref(this.__mash.media,i)&&console.error("remove_media no mash media",t,this.__mash.media),delete this.__media_references[t])},pt.select=function(e,t){var i,r=[],a="__selected_clips",s="selectedClips",n=Mash.media(this.__mash,e);if(n)if(Constant.effect===n.type&&(a="__selected_effects",s="selectedEffects"),t)switch(i=this[a].indexOf(e),this[a].length){case 0:r.push(e);break;case 1:if(-1<i)break;default:i<0?(r.push(e),r=r.concat(this[a])):(i&&(r=r.concat(this[a].slice(0,i))),i<this[a].length-1&&(r=r.concat(this[a].slice(i+1))))}else{if(-1<this[a].indexOf(e))return;r.push(e)}this[s]=r},pt.selected=function(e){return-2<this.__selected_effects.indexOf(e)+this.__selected_clips.indexOf(e)},pt.selectEffect=function(e,t){if(Util.isob(e))return this.select(e,t);t||(this.selectedEffect=e)},pt.split=function(){var e=this.selectedClip,t=this.__time.copyTime();Util.isob(e)&&this.__canSplitAtTime(e,t)&&(t=this.__action_split_clip(e,t),this.__action_add(t))},pt.freeze=function(){var e=this.selectedClip,t=this.__time.copyTime();Util.isob(e)&&this.__canSplitAtTime(e,t)&&(t=this.__action_freeze_clip(e,t),this.__action_add(t))},pt.undo=function(){-1<this.__action_index&&(this.__action_stack[this.__action_index].undo(),this.__action_index--,this.did(),this.__changed_mash_or_time())},pt.uuid=function(){return Util.uuid()},pt.__action_add=function(e){var t,i,r;if(this.__action_index<this.__action_stack.length-1)for(i=(r=this.__action_stack.splice(this.__action_index+1,this.__action_stack.length-(this.__action_index+1))).length,t=0;t<i;t++)r[t].destroy();this.__action_stack.push(e),this.redo(i)},pt.__action_clips_move=function(e,t,i,r){r.sort(Util.sort_by_frame);var a,s,n=r.length,o=this.__mash[e][t],_=o,c=r[0];if(-1===o.clips.indexOf(c)&&(_=Mash.track_for_clip(this.__mash,c),Util.isnt(_)))return console.error("clip not found in tracks",c),!1;for(a=[],s=0;s<n;s++)c=r[s],a.push({clip:c,offset:s?c.frame-r[0].frame:0,frame:c.frame,track:c.track,i:s,index:_.clips.indexOf(c)});return new Action(this,function(){if(o!==_)for(a.sort(function(e,t){return t.index-e.index}),s=0;s<n;s++)_.clips.splice(a[s].index,1);for(a.sort(function(e,t){return e.i-t.i}),o!==_&&(o.clips=o.clips.concat(r)),s=n-1;-1<s;s--)(c=r[s]).track=t,c.frame=i+a[s].offset;o!==_&&Mash.recalc_track(this.player.mash,_),Mash.recalc_track(this.player.mash,o),this.player.mash_length_changed()},function(){if(a.sort(function(e,t){return e.index-t.index}),o!==_)for(s=0;s<n;s++)Util.array_delete(o.clips,r[s]);for(s=0;s<n;s++)(c=a[s].clip).frame=a[s].frame,o!==_&&(_.clips.splice(a[s].index,0,c),c.track=a[s].track);o!==_&&Mash.recalc_track(this.player.mash,_),Mash.recalc_track(this.player.mash,o),this.player.mash_length_changed()})},pt.__action_effects_move=function(e,t,i){for(var r=t.length,a=[],s=new Action(this,function(){for(a.sort(function(e,t){return t.i-e.i}),n=0;n<r;n++)i.splice(a[n].i,1);for(n=r-1;-1<n;n--)i.splice(e,0,t[n])},function(){for(a.sort(function(e,t){return e.i-t.i}),n=0;n<r;n++)i.splice(e,1);for(n=0;n<r;n++)i.splice(a[n].i,0,a[n].effect)}),n=0;n<r;n++)a.push({i:i.indexOf(t[n]),effect:t[n]});return s},pt.__action_video_move=function(e,t,i){var r,a,s=i.length,n=this.__mash.video[e],o=n,_=i[0];if(-1===n.clips.indexOf(_)&&!(o=Mash.track_for_clip(this.__mash,_)))return console.error("no track for first clip");for(r=[],a=0;a<s;a++)_=i[a],r.push({clip:_,frame:_.frame,track:_.track,i:a,index:o.clips.indexOf(_)});return new Action(this,function(){for(r.sort(function(e,t){return t.index-e.index}),a=0;a<s;a++)o.clips.splice(r[a].index,1);for(r.sort(function(e,t){return e.i-t.i}),a=s-1;-1<a;a--)_=i[a],n.clips.splice(t,0,_),_.track=e;n!==o&&Mash.recalc_track(this.player.mash,o),Mash.recalc_track(this.player.mash,n),this.player.mash_length_changed()},function(){for(r.sort(function(e,t){return e.index-t.index}),n.clips.splice(t,s),a=0;a<s;a++)_=r[a].clip,o.clips.splice(r[a].index,0,_),_.track=r[a].track,_.frame=r[a].frame;n!==o&&Mash.recalc_track(this.player.mash,o),Mash.recalc_track(this.player.mash,n),this.player.mash_length_changed()})},pt.__action_clips_remove=function(e,t,i){i.sort(Util.sort_by_frame);for(var r=i.length,a=this.__mash[e][t],s=i[0],n=[],o=0;o<r;o++)s=i[o],n.push({offset:o?s.frame-i[0].frame:0,frame:s.frame,track:s.track,i:o,index:a.clips.indexOf(s)});return new Action(this,function(){for(n.sort(function(e,t){return t.index-e.index}),o=0;o<r;o++)a.clips.splice(n[o].index,1);Mash.recalc_track(this.player.mash,a),this.player.mash_length_changed()},function(){for(n.sort(function(e,t){return e.index-t.index}),o=0;o<r;o++)s=i[n[o].i],a.clips.splice(n[o].index,0,s),s.track=n[o].track,s.frame=n[o].frame;Mash.recalc_track(this.player.mash,a),this.player.mash_length_changed()})},pt.__action_effects_remove=function(e,t){var i,r=e.length,a=new Action(this,function(){for(this.orig.sort(function(e,t){return t.index-e.index}),i=0;i<r;i++)t.splice(this.orig[i].index,1)},function(){for(this.orig.sort(function(e,t){return e.index-t.index}),i=0;i<r;i++)t.splice(this.orig[i].index,0,e[this.orig[i].i])});for(a.orig=[],i=0;i<r;i++)a.orig.push({i:i,index:t.indexOf(e[i])});return a},pt.__action_video_remove=function(e,t){for(var i=t.length,r=this.__mash.video[e],a=t[0],s=[],n=0;n<i;n++)a=t[n],s.push({frame:a.frame,track:a.track,i:n,index:r.clips.indexOf(a)});return new Action(this,function(){for(s.sort(function(e,t){return t.index-e.index}),n=0;n<i;n++)r.clips.splice(s[n].index,1);Mash.recalc_track(this.player.mash,r),this.player.mash_length_changed()},function(){var e;for(s.sort(function(e,t){return e.index-t.index}),n=0;n<i;n++)e=s[n].index,a=t[s[n].i],r.clips.splice(e,0,a),a.track=s[n].track,a.frame=s[n].frame;Mash.recalc_track(this.player.mash,r),this.player.mash_length_changed()})},pt.__action_effect_add=function(e,t){var i,r,a=this.selectedClipOrMash;return a&&(r=a.effects,i=new Action(this,function(){r.splice(t,0,e)},function(){Util.array_delete(r,e)})),i},pt.__action_freeze_clip=function(e,t){console.warn("testing __action_freeze_clip");var i=Mash.media(this.__mash,e),r=Util.copy_keys_recursize(e),a=Util.copy_keys_recursize(e),s=2*this.__mash.quantize;t.scale(i.fps),a.freeze=t.frame,a.frames=s,t.scale(this.__mash.quantize);var n=e.frames-(t.frame-e.frame),o=Mash.track_for_clip(this.__mash,e).clips,_=1+o.indexOf(e);r.frames=n,r.frame=e.frame+s+(e.frames-n),r.trim=e.trim+n;s=new Action(this,function(){o.splice(_,0,r),o.splice(_,0,a),e.frames-=n,Mash.recalc_video_clips(this.player.mash,this.target)},function(){e.frames+=n,o.splice(_,2),Mash.recalc_video_clips(this.player.mash,this.target)});return s.redo_selected_clips=[e],s.target=o,s},pt.__action_split_clip=function(e,t){t.scale(this.__mash.quantize);var i=e.frames,r=Mash.media(this.__mash,e),a=Mash.track_for_clip(this.__mash,e).clips,s=1+a.indexOf(e),n=Util.copy_keys_recursize(e),o=e.frame,t=t.frame,_=t-o;switch(n.frames=i-_,n.frame=t,r.type){case Constant.audio:case Constant.video:n.trim+=_}t=new Action(this,function(){a.splice(s,0,n),e.frames=_},function(){e.frames=i,a.splice(s,1)});t.redo_selected_clips=[n],t.undo_selected_clips=[e];r=Mash.media_for_clips(this.__mash,n,r);return t.redo_add_objects=r,t.undo_delete_objects=r,t},pt.__action_track_add=function(e,t,i,r){var a=new Action(this,function(){for(var e,t=0;t<this.tracks;t++)this.player.__track_create(this.type);e=this.player.mash[this.type][this.index].clips,this.clip.frame=this.frame,e.push(this.clip),Mash.recalc_clips(e),this.player.mash_length_changed()},function(){var e=this.player.mash[this.type][this.index].clips;Util.array_delete(e,this.clip);for(var t=0;t<this.tracks;t++)this.player.__track_delete(this.type);Mash.recalc_clips(e),this.player.mash_length_changed()});return a.clip=t,a.frame=r,a.index=i,a.type=Constant.audio===e?e:Constant.video,a.tracks=i+1-this.__mash[a.type].length,a},pt.__action_video_add=function(e,t,i){var r=new Action(this,function(){this.target.splice(this.index,0,this.clip),Mash.recalc_video_clips(this.player.mash,this.target),this.player.mash_length_changed()},function(){Util.array_delete(this.target,this.clip),Mash.recalc_video_clips(this.player.mash,this.target),this.player.mash_length_changed()});return r.clip=e,r.index=i,r.target=this.__mash.video[t].clips,r},pt.__adjust_gain=function(e){for(var t,i,r=e.length,a=0;a<r;a++)i=e[a],t=Mash.media(this.__mash,i),Mash.clip_has_audio(i,t)&&(i=Audio.source_for_clip(i),Audio.gain_source(i))},pt.__audio_is_on=function(){return!this.__paused&&!this.__muted&&this.__gain},pt.__canSplitAtTime=function(e,t){var i=new TimeRange(e.frame,this.__mash.quantize,e.frames),e=i.intersection(t);return e&&((t=t.copyTime()).scale(i.fps),e=(e=t.frame!==i.frame)&&t.end!==i.end),e},pt.__delete_drawings=function(e){if(e)for(var t=e.pop();t;)this.__delete_drawings(t.drawings),t!==this.__drawing&&Filter.destroy_drawing(t),t=e.pop()},pt.__draw_context=function(e){(e=e||this.__drawing.context)&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=this.__mash.backcolor,e.fillRect(0,0,e.canvas.width,e.canvas.height))},pt.__draw_layer_clip=function(e,t,i,r){function a(e,t,i){return e+"x"+t+" "+i.type+" clip "+(i.label||i.id)}var s,n,o,_,c,l,f=this.__mash.quantize;switch(i.type){case Constant.image:s=i.url||i.source,(o=Loader.cached_urls[s])&&(c=o.width,l=o.height,(_=Filter.create_drawing(c,l,a(c,l,i),r.container)).context.drawImage(o,0,0,c,l,0,0,c,l));break;case"frame":case Constant.video:for(s in(n=e.copyTime()).scale(i.fps),n.frames=1,Mash.urls_for_video_clip(t,i,n,f)){(o=Loader.cached_urls[s])&&(c=o.width,l=o.height,(_=Filter.create_drawing(c,l,a(c,l,i),r.container)).context.drawImage(o,0,0,c,l,0,0,c,l));break}break;case Constant.theme:_=this.__draw_module_filters(e,t,[r],t,i).shift();break;default:console.error(i.type+" unsupported on video track")}return _&&(r.drawings.push(_),r=this.__draw_scale_and_effects(e,t,_)),r},pt.__draw_layer_clips=function(e,t){this.__delete_drawings(this.__drawing.drawings);for(var i,r,a,s,n,o,_,c=e.length,l={},f=-1,d=[],h=0;h<c;h++)a=e[h],l[(s=Mash.media(this.__mash,a)).id]=s,Constant.audio!==s.type&&0===a.track&&(Constant.transition===s.type?f=h:d.push(h));if(this.__draw_context(),-1<f){if(0<(_=d.length)){for(n=this.__drawing.canvas.width,o=this.__drawing.canvas.height,h=0;h<_;h++)s=l[(a=e[d[h]]).id],i=Filter.create_drawing(n,o,n+"x"+o+" background for "+s.type+" clip "+(s.label||s.id),this.__drawing.container),this.__drawing.drawings.push(i),this.__draw_context(i.context),r=this.__draw_layer_clip(t,a,s,i),this.__drawings_merge(t,a,a.merger,i,r);a=e[f],this.__draw_transition(this.__drawing.drawings,a,l[a.id],t)}d.push(f)}else d=[];for(h=0;h<c;h++)-1<d.indexOf(h)||(s=l[(a=e[h]).id],Constant.audio!==s.type&&(r=this.__draw_layer_clip(t,a,s,this.__drawing),this.__drawings_merge(t,a,a.merger,this.__drawing,r)))},pt.__draw_transition=function(e,t,i,r){e.length<2&&e.push(this.__drawing);var a=e[0],e=e[1];i.to.filters&&(e=this.__draw_module_filters(r,t,[e],t,i.to).shift()),i.from.filters&&(a=this.__draw_module_filters(r,t,[a],t,i.from).shift()),this.__drawings_merge(r,t,i.from.merger,a,e),this.__drawings_merge(r,t,i.to.merger,this.__drawing,a)},pt.__draw_request=function(e){var t=this;requestAnimationFrame(function(){t.__draw_layer_clips(e,t.__time_drawn)})},pt.__drawings_merge=function(e,t,i,r,a){var s;i?(s=Mash.media_search(Constant.merger,i,this.__mash))?r=this.__draw_module_filters(e,t,[r,a],i,s).shift():console.error("no merger media",i):console.error("false merger",t)},pt.__draw_scale_and_effects=function(e,t,i){var r,a=t.scaler;return a?((r=Mash.media_search(Constant.scaler,a,this.__mash))?i=this.__draw_module_filters(e,t,[i],a,r).shift():console.error("no scaler media",a),i||console.error("scaler produced no drawing",a,t)):console.error("no scaler found",t),i=Util.isarray(t.effects)&&t.effects.length?this.__draw_effects([i],t,e).shift():i},pt.__draw_module_filters=function(time,layer_clip,drawings,module,module_media){var __evaluate_scope=function __evaluate_scope(time,clip,scope,module,filter_config){var eval_key,eval_str,filter,conditional_in,condition,test_bool,parameter,conditional,parameter_name,parameter_value,parameters_array,j,y,i,z,evaluated={},filter=Filter.load(filter_config.id);if(filter)if(scope=Util.copy_ob(scope),parameters_array=filter_config.parameters,parameters_array=parameters_array||filter.parameters,parameters_array){for(z=parameters_array.length,i=0;i<z;i++)if(parameter=parameters_array[i],parameter_name=parameter.name,parameter_name){if(parameter_value=parameter.value,Util.isarray(parameter_value)){for(test_bool=!1,y=parameter_value.length,j=0;j<y;j++){for(eval_key in conditional=parameter_value[j],condition=conditional.condition,conditional.is?condition=condition+"=="+conditional.is:conditional.in&&(conditional_in=conditional.in,Util.isstring(conditional_in)&&(conditional_in=conditional_in.split(",")),condition="(-1 < ["+conditional_in.join(",")+"].indexOf("+(Util.isstring(conditional_in[0])?"String":"Number")+"("+condition+")))"),condition=condition.replace(" or "," || "),condition=condition.replace(" and "," && "),scope)condition=condition.replace(new RegExp("\\b"+eval_key+"\\b","g"),"scope."+eval_key);eval_str="test_bool = ("+condition+");";try{eval(eval_str)}catch(exception){console.error(exception.message,eval_str)}if(test_bool){parameter_value=conditional.value;break}}test_bool||console.error("no conditions were true",parameter_value)}if(Util.isstring(parameter_value))for(eval_key in scope)parameter_value=parameter_value.replace(new RegExp("\\b"+eval_key+"\\b","g"),"scope."+eval_key);eval_str="evaluated."+parameter_name+" = "+parameter_value+";";try{eval(eval_str)}catch(exception){evaluated[parameter_name]=parameter_value}scope[parameter_name]=evaluated[parameter_name]}}else console.error("no parameters_array found",filter_config);else console.error("filter not found",filter_config.id);return evaluated},ctime,scope,evaluated,filter_config,filter,i,z;if(module_media)if(module_media.filters)if(layer_clip.frames)for(ctime=new TimeRange(0,this.__mash.quantize,this.__mash_length),ctime.frame=layer_clip.frame,ctime.frames=layer_clip.frames,z=module_media.filters.length,i=0;i<z;i++)filter_config=module_media.filters[i],filter=Filter.load(filter_config.id),filter&&(scope=this.__module_scope(time,ctime,drawings,module,module_media),filter.parse&&(scope=filter.parse(drawings,scope,filter_config)),evaluated=__evaluate_scope(time,layer_clip,scope,module,filter_config),filter.render&&(drawings=filter.render(drawings,scope,evaluated,filter_config)));else console.error("invalid layer clip with no frames",layer_clip);else console.error("invalid module media with no filters",module,module_media);else console.error("false media while drawing module filters",module,layer_clip);return drawings},pt.__draw_effects=function(e,t,i){var r,a,s;if(t)if(t.frames)if(t.effects)for(s=t.effects.length-1;-1<s;s--)r=t.effects[s],(a=Mash.media(this.__mash,r))?e=this.__draw_module_filters(i,t,e,r,a):console.error("could not find effect media",r,t,this.__mash.media);else console.error("invalid layer clip with no effects",t);else console.error("invalid layer clip with no frames, so no effects",t);else console.error("false layer clip, so no effects",e);return e},pt.__limit_time=function(e){var t=e.copyTime(),e=new TimeRange(this.__mash_length,this.__mash.quantize);return e.frame=Math.max(0,e.frame-1),t.min(e),t.scale(this.__fps,"floor"),t},pt.__load_timed=function(){var e;this.__moving&&((e=TimeRange.fromSeconds(Audio.time(),this.__fps,"ceil")).frame!==this.__limit_time(e).frame?this.__loop?(this.frame=0,this.paused=!1):this.paused=!0:e.isEqualToTime(this.__time_drawn)||(this.__time.setToTime(e),this.redraw()))},pt.__module_scope=function(e,t,i,r,a){if(!this.__drawing.canvas)return{};var s,n,o,_,c={};if(a.properties)for(o in a.properties)s=r[o],Util.isnt(s)?(s=(_=a.properties[o]).value,Util.isnt(s)&&((_=_.type)&&(n=Constant.property_types[_])&&(s=n.value),Util.isnt(s)&&(s=""))):s=r[o],c[o]=s;function l(e,t,i){var r=parseFloat(t),a=parseFloat(c[e]),t=a*r;return!i||a<(e=parseFloat(c["mm_height"===e?"mm_width":"mm_height"]))&&(t=a+(r-1)*e),t}return c.mm_vert=function(e,t){return l("mm_height",e,t)},c.mm_horz=function(e,t){return l("mm_width",e,t)},c.mm_cmp=function(e,t,i,r){return t<e?i:r},c.mm_max=Math.max,c.mm_min=Math.min,c.floor=Math.floor,c.ceil=Math.ceil,c.mm_fps=this.__fps,t&&(c.t=c.mm_duration=t.lengthSeconds),t.scale(e.fps),c.mm_t=(e.frame-t.frame)/t.frames,c.mm_width=this.__drawing.canvas.width,c.mm_height=this.__drawing.canvas.height,(t=i[i.length-1])&&t.canvas?(c.mm_input_width=t.canvas.width,c.mm_input_height=t.canvas.height,c.mm_input_dimensions=c.mm_input_width+"x"+c.mm_input_height):console.warn("no drawing?",i),c.mm_dimensions=c.mm_width+"x"+c.mm_height,c},pt.__changed_mash_or_time=function(e){e&&this.__time.setToTime(e),this.paused=!0,this.redraw()},pt.__set_moving=function(e){var t;this.__moving!==e&&(this.__moving=e,this.__moving?((t=this).__load_timer=setInterval(function(){t.__load_timed()},500/this.__fps),Audio.start(this.__time.seconds),this.rebuffer()):(Audio.stop(),clearInterval(this.__load_timer),this.__load_timer=0),this.__set_stalling(!this.__moving&&!this.__paused))},pt.__set_stalling=function(e){var t=!1;return this.__stalling!==e&&(this.__stalling=e,t=!0),t},pt.__stop_buffer_timer=function(){this.__bufferProcessTimer&&(clearInterval(this.__bufferProcessTimer),this.__bufferProcessTimer=0)},pt.__track_create=function(e){var t=this.__mash[e];t.push(Mash.init_track(e,t.length))},pt.__track_delete=function(e){e=this.__mash[e].pop();this.__mash_length===Mash.length_of_clips(e.clips)&&this.mash_length_changed()}}(Player.prototype),MovieMasher.Player=Player,Players={draw_delayed:function(){Players.delayed_timer||(Players.delayed_timer=setTimeout(function(){Players.delayed_timer=0;for(var e=Players.instances.length,t=0;t<e;t++)Players.instances[t].redraw()},50))},start_playing:function(e){Players.stop_playing(),Players.current=e,Audio.create_buffer_source()},stop_playing:function(){Players.current&&(Players.current.paused=!0,Players.current=null,Audio.stop(),Audio.destroy_buffer_source())},instances:[],current:null,delayed_timer:0},MovieMasher.Players=Players,TimeRange=function(e,t,i){e&&(this.frame=Number(e)||0),t&&(this.fps=Number(t)||0),i&&(this.frames=Math.max(1,Number(i)))},TimeRange.fromTimes=function(e,t){return e.synchronize(t),new TimeRange(e.frame,e.fps,Math.max(1,t.frame-e.frame))},TimeRange.fromSeconds=function(e,t,i){return i=i||"round",t=t||1,new TimeRange(Math[i](Number(e)*Number(t)),t)},TimeRange.fromSomething=function(e){var t,i,r;return e?"number"==typeof e?e=new TimeRange.fromSeconds(e):"string"==typeof e&&(t=(e=e.split("-")).shift(),i=r=1,e.length?i=(e=e.shift().split("@")).shift():t=(e=t.split("@")).shift(),e.length&&(r=e.shift()),e=new TimeRange(t,r,i)):e=new TimeRange,e},function(e){e.frames=0,e.frame=0,e.fps=0,Object.defineProperty(e,"end",{get:function(){return this.frame+this.frames},set:function(e){this.frames=Math.max(1,Number(e)-Number(this.frame))}}),Object.defineProperty(e,"endTime",{get:function(){return new TimeRange(this.end,this.fps)}}),Object.defineProperty(e,"description",{get:function(){var e=this.frame;return this.frames&&(e+="-"+this.end),e+="@"+this.fps}}),Object.defineProperty(e,"seconds",{get:function(){return Number(this.frame)/Number(this.fps)},set:function(e){this.setToTime(e)}}),Object.defineProperty(e,"lengthSeconds",{get:function(){return Number(this.frames)/Number(this.fps)}}),Object.defineProperty(e,"timeRange",{get:function(){var e=this.copyTime();return e.frames=1,e}}),e.add=function(e){return this.fps!==e.fps&&(e=e.copyTime(),this.synchronize(e)),this.frame+=e.frame,this},e.setToTime=function(e){return e=TimeRange.fromSomething(e),this.synchronize(e),this.frame=e.frame,e},e.setToTimeRange=function(e){return e=this.setToTime(e),this.frames=e.frames,e},e.copyTime=function(e){return new TimeRange(this.frame,this.fps,e)},e.divide=function(e,t){t=t||"round",this.frame=Math[t](Number(this.frame)/e)},e.frameForRate=function(e,t){t=t||"round";var i=this.frame;return i=e!==this.fps?TimeRange.fromSeconds(this.seconds,this.fps,t).frame:i},e.isEqualToTime=function(e){var t,i=!1;return i=e&&e.fps&&this.fps?this.fps===e.fps?this.frame===e.frame:(t=this.copyTime(),e=e.copyTime(),t.synchronize(e),t.frame===e.frame):i},e.lessThan=function(e){var t,i=!1;return i=e&&e.fps&&this.fps?this.fps===e.fps?this.frame<e.frame:(t=this.copyTime(),e=e.copyTime(),t.synchronize(e),t.frame<e.frame):i},e.max=function(e){e&&(this.synchronize(e),this.frame=Math.max(e.frame,this.frame))},e.min=function(e){e&&(this.synchronize(e),this.frame=Math.min(e.frame,this.frame))},e.multiply=function(e,t){t=t||"round",this.frame=Math[t](Number(this.frame)*e)},e.ratio=function(e){var t,i=0;return i=e&&e.fps&&this.fps&&e.frame?this.fps===e.fps?this.frame/e.frame:(t=this.copyTime(),e=e.copyTime(),t.synchronize(e),Number(t.frame)/Number(e.frame)):i},e.scale=function(e,t){return this.fps!==e&&(t=t||"round",this.frame=Math[t](Number(this.frame)/(Number(this.fps)/Number(e))),this.frames&&(this.frames=Math.max(1,Math[t](Number(this.frames)/(Number(this.fps)/Number(e))))),this.fps=e),this},e.subtract=function(e){this.fps!==e.fps&&(e=e.copyTime(),this.synchronize(e));e=e.frame;return e>this.frame&&(e-=e-this.frame),this.frame-=e,e},e.synchronize=function(e,t){var i;t=t||"round",e.fps!==this.fps&&(i=this.__lcm(e.fps,this.fps),this.scale(i,t),e.scale(i,t))},e.__gcd=function(e,t){for(var i;0!==t;)t=e%(i=t),e=i;return e},e.__lcm=function(e,t){return e*t/this.__gcd(e,t)},e.copyTimeRange=function(){return new TimeRange(this.frame,this.fps,this.frames)},e.touches=function(e){return this.intersection(e,!0)},e.intersection=function(e,t){var i=null,r=this,a=e;r.fps!==a.fps&&(r=r.copyTimeRange(),a=a.copyTimeRange(),r.synchronize(a));e=Math.max(r.frame,a.frame),a=Math.min(r.end+(r.frames?0:1),a.end+(a.frames?0:1));return i=e<a||t&&e===a?new TimeRange(e,r.fps,a-e):i},e.isEqualToTimeRange=function(e){var t,i=!1;return i=e&&e.fps&&this.fps?this.fps===e.fps?this.frame===e.frame&&this.frames===e.frames:(t=this.copyTimeRange(),e=e.copyTimeRange(),t.synchronize(e),t.frame===e.frame&&t.frames===e.frames):i},e.maxLength=function(e){this.synchronize(e),this.frames=Math.max(e.frame,this.frames)},e.minLength=function(e){this.synchronize(e),this.frames=Math.min(e.frame,this.frames)}}(TimeRange.prototype),MovieMasher.TimeRange=TimeRange;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Util={array_empty:function(e){for(;0<e.length;)e.pop()},array_add:function(e,t){e&&Util.isarray(e)&&-1===e.indexOf(t)&&e.push(t)},array_key:function(e,t,i,r){return Util.array_find(e,t,r)[i]},array_find:function(e,t,i){var r,a,s=null;if(e&&Util.isarray(e)&&(Util.isnt(i)&&(i="id"),Util.isob(t)&&(t=t[i]),!Util.isnt(t)))for(a=e.length,r=0;r<a&&(!(s=e[r])||s[i]!==t);r++)s=null;return s},array_delete:function(e,t){var i;Util.isarray(e)&&-1<(i=e.indexOf(t))&&e.splice(i,1)},array_delete_ref:function(e,t,i){var r,a=-1;return Util.isarray(e)&&(r=this.array_find(e,t,i))&&-1<(a=e.indexOf(r))&&e.splice(a,1),a},array_replace:function(e,t,i){i=this.array_delete_ref(e,t,i);-1<i?e.splice(i,0,t):e.push(t)},contents_match:function(e,t){var i,r,a=!0;if(e&&t&&e.length===t.length)for(r=e.length,i=0;i<r;i++)if(e[i]!==t[i]){a=!1;break}return a},copy_array:function(e,t){t=t||[];for(var i=e.length,r=0;r<i;r++)t.push(e[r]);return t},copy_ob:function(e,t){if(!Util.isnt(e))for(var i in t=t||{},e)Util.copy_key_valid(i)&&(t[i]=e[i]);return t},copy_key_valid:function(e){return"$"!==e.substr(0,1)},copy_ob_scalars:function(e,t,i){if(!Util.isnt(e))for(var r in Util.isnt(t)&&(t={}),e)Util.copy_key_valid(r)&&(Util.isob(e[r])||i&&!Util.isnt(t[r])||(t[r]=e[r]));return t},copy_keys_recursize:function(e,t){var i,r;if(Util.isob(e))for(i in Util.isnt(t)&&(t={}),e)Util.copy_key_valid(i)&&(r=e[i],Util.isob(r)?Util.isarray(r)?t[i]=Util.copy_array(r):t[i]=Util.copy_keys_recursize(r,t[i]):t[i]=r);return t},index_after_removal:function(e,t,i){for(var r,a,s=[],n=t.length,o=0;o<n;o++)a=i.indexOf(t[o]),s.push(a),-1<a&&a<e&&e--;for(o=0;o<n&&!(r=e+o!==s[o]);o++);return e=!r?-2:e},is:function(e){return!Util.isnt(e)},is_typeof:function(){for(var e,t=!1,i=arguments.length,r=0;r<i&&(r?t=_typeof(arguments[r])===e:e=arguments[r],!t);r++);return t},isarray:function(){for(var e=!1,t=arguments.length,i=0;i<t&&(e=arguments[i]?Util.isnt(Array.isArray)?arguments[i]instanceof Array:Array.isArray(arguments[i]):e);i++);return e},isempty:function(e){return!(this.isob(e)&&this.ob_keys(e).length)},isnt:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["undefined"]))},isob:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["object"]))},isstring:function(){return this.is_typeof.apply(this,this.copy_array(arguments,["string"]))},keys_found_equal:function(e,t){var i,r=!0;for(i in e)if(!(r=e[i]===t[i]))break;return r},keys_match:function(e,t){var i,r=!0;for(i in e)if(Util.isnt(t[i])){r=!1;break}if(r)for(i in t)if(Util.isnt(e[i])){r=!1;break}return r},ob_keys:function(e){var t,i=[];if(Util.isob(e))for(t in e)i.push(t);return i},ob_property:function(e,t){var i,r,a=null;if(Util.isob(e)&&!Util.isnt(t)&&t.length)for(r=(t=t.split(".")).length,i=0;i<r;i++){if(e=e[t[i]],Util.isnt(e)){a=null;break}a=e}return a},ob_values:function(e){var t,i=[];if(Util.isob(e))for(t in e)i.push(e[t]);return i},pad:function(e,t,i){return i=i||"0",(e=String(e)).length>=t?e:new Array(t-e.length+1).join(i)+e},pluralize:function(e,t){return 1!==e&&(t+="s"),t},set_ob_property:function(e,t,i){var r,a;if(Util.isob(e)&&!Util.isnt(t)&&t.length){for(a=(t=t.split(".")).length-1,r=0;r<a;r++)if(e=e[t[r]],!Util.isob(e)){e=null;break}e&&(e[t[r]]=i)}},sort_by_frame:function(e,t){return e.frame-t.frame||e.frames-t.frames},sort_by_label:function(e,t){return e.label<t.label?-1:e.label>t.label?1:0},sort_numeric:function(e,t){return e-t},sort_numeric_desc:function(e,t){return t-e},uuid:function(){return function e(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}()}};MovieMasher.Util=Util;